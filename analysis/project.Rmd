---
title: "Alcohol Consumption Patterns"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    theme: bootstrap
    orientation: columns
    vertical_layout: scroll
---
   

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(maps)
library(plotly)
library(flexdashboard)
library(kableExtra)
library(rnaturalearth)
library(RColorBrewer)
library(sf)
library(viridis)
library(leaflet)
library(stringr)
library(shiny)
library(gridExtra)
library(ggiraph)
library(gganimate)
library(naniar)
```

Introduction {.tabset}
======================

Column {.tabset} {data-width=800}
-------------------------------------

### Background

Alcohol is a psychoactive substance with dependent properties that has been widely consumed in many cultures for centuries. It has been consumed for a wide variety of purposes from celebration to mourning. Countries around the world also have different drinking cultures.
But the harmful use of alcohol can impose a heavy disease on the person. It also results in a social and economic burden on society. As one of the major risk factors for the health of the global population, WHO Member States in 2010 discussed and agreed to an international consensus on the Global Strategy to Reduce the Harmful Use of Alcohol.
The reproducible report will use WHO's definitive data on alcohol and health as a dataset to further analyse alcohol consumption and the impact it has on society.


Column {.tabset} {data-width=200}
-------------------------------------

   
### Approach of Project

The report will be collating specific sections of this data pertaining to countrywise policy responses, consumption pattern, youth and alcohol, levels of consumption and harms and consequences.

### Information on Data

This report is being created using the data from the GISAH (Global Information System on Alcohol and Health) tool of the World Health Organisation. GISAH tool helps monitor trends relating to alcohol consumption across various age groups, side effects (harm caused) as well as the policy responses by different countries.

### Makers

**Team Name: Hayaku**

_Researchers:_

- _Kexin Xu_
- _Smriti Vinayak Bhat_
- _Yalong liu_
- _Yin Shan Ho_


Popularity {.tabset}
======================

Column {data-width=650}
-------------------------------------

### Popularity of each alcoholic beverage over time

```{r}
consumption <- read_csv("../clean_data/consumption_join.csv")

consumption[consumption == 0] <- NA
```

```{r}
# Pivoting Beverage_Types and Year

c_tidy <- consumption %>%
  rename(Types = Beverage_Types) %>%
  pivot_longer(cols = -c(Country, Types),
               names_to = "Year",
               values_to = "Litres") %>%
  mutate(Types = recode(Types,
                        "All types" = "All_types",
                        "Other alcoholic beverages" = "Other_alcoholic_beverages")) %>%
  pivot_wider(names_from = Types,
              values_from = Litres) %>%
  mutate(All_types = as.double(as.character(All_types))) %>%
  mutate(Beer = as.double(as.character(Beer))) %>% 
  mutate(Wine = as.double(as.character(Wine))) %>% 
  mutate(Spirits = as.double(as.character(Spirits))) %>% 
  mutate(Other_alcoholic_beverages = as.double(as.character(Other_alcoholic_beverages))) 
```

```{r}
# Loading countries data

Countries <- ne_countries(returnclass = "sf", scale = "medium") %>%
  select(admin, continent, pop_est, gdp_md_est, economy, income_grp)
```

```{r}
# Test unmatched countries

country_test <- anti_join(c_tidy, Countries, by = c("Country" = "admin"))

# Modify the country name consisting with rnaturalearth package

c_tidy <- c_tidy %>%
  mutate(Country = recode(Country,
                             "Bahamas" = "The Bahamas",
                             "Bolivia (Plurinational State of)" = "Bolivia",
                             "Brunei Darussalam" = "Brunei",
                             "Cabo Verde" = "Cape Verde",
                             "Congo" = "Democratic Republic of the Congo",
                             "CÃ´te d'Ivoire" = "Ivory Coast",
                             "Czechia" = "Czech Republic",
                             "Democratic People's Republic of Korea" = "North Korea",
                             "Eswatini" = "Swaziland",
                             "Guinea-Bissau" = "Guinea Bissau",
                             "Iran (Islamic Republic of)" = "Iran",
                             "Lao People's Democratic Republic" = "Laos",
                             "Micronesia (Federated States of)" = "Federated States of Micronesia",
                             "North Macedonia" = "Macedonia",
                             "Republic of Korea" = "South Korea",
                             "Republic of Moldova" = "Moldova",
                             "Russian Federation" = "Russia",
                             "Serbia" = "Republic of Serbia",
                             "Syrian Arab Republic" = "Syria",
                             "Timor-Leste" = "East Timor",
                             "Tuvalu" = "Wallis and Futuna",
                             "United Kingdom of Great Britain and Northern Ireland" = "United Kingdom", 
                             "Venezuela (Bolivarian Republic of)" = "Venezuela",
                             "Viet Nam" = "Vietnam"))
```

```{r}
spirit_data <- c_tidy %>%
  pivot_longer(cols = All_types:Other_alcoholic_beverages,
               names_to = "Types",
               values_to = "Litres") %>%
  filter(!str_detect(Types, "All")) %>%
  group_by(Country, Year) %>%
  slice(which.max(Litres))
```

```{r}
type_time <- left_join(Countries, spirit_data, by = c("admin" = "Country"))

  t_time  <- ggplot() +
  geom_sf(data = type_time %>% 
  filter(!is.na(Year)), mapping = aes(fill = Types)) +
  scale_fill_brewer(palette = "Set2", na.value="white") +
  labs(title = "Popularity of each type alcohol",
       subtitle = "Year: {current_frame}",
       fill = "Total") +
  theme_void() +
  theme(legend.position = "bottom") +
  
  transition_manual(Year) 
  animate(t_time, duration = 20, fps = 20, width = 1060, height = 480)
```

### Changes in the popularity of various alcoholic beverages

```{r}
t_tidy <- c_tidy %>%
  rename(All = All_types, Other = Other_alcoholic_beverages)

spain_wine <- t_tidy %>%
  filter(Country == "Spain") %>%
  pivot_longer(cols = -c(Country, Year),
               names_to = "Types",
               values_to = "Litres")  %>%
  mutate(Year = as.double(Year)) %>%
  group_by(Types,Year) %>%
  na.omit()

  spain_wine %>%
  ggplot(aes(x = Year,
            y = Litres,
            color = Types)) +
  geom_line(size = 1.5) +
  theme_linedraw() +
  theme(panel.grid.major.x = element_blank(), 
          axis.ticks.y = element_blank(),
          panel.border = element_blank()) +
  labs(title = "Alcohol per capita (15+) consumption (in litres of pure alcohol) in Spain",
       y = "Litres of pure alcohol",
       legend.position='dodge') +
  scale_color_brewer(palette = "BrBG") +
  scale_x_continuous(breaks=seq(1960, 2020, 5)) 
  ggplotly()
```

Column {data-width=350}
-------------------------------------

### Total consumption 

```{r}
trend_total <- t_tidy %>%
  pivot_longer(cols = -c(Country, Year),
               names_to = "Types",
               values_to = "Litres") %>%
  mutate(Year = as.double(Year)) %>%
  group_by(Types,Year) %>%
  na.omit() %>%
  summarise(sum = sum(Litres, na.rm = TRUE))
  
  trend_total %>%
  ggplot(aes(x = Year,
            y = sum,
            group = Types,
            color = Types)) +
  geom_line(size = 1.5) +
    theme_classic() +
    theme(panel.grid.major.x = element_blank(), 
          axis.ticks.y = element_blank(),
          legend.position='bottom') +
    labs(title = "Total alcohol consumption per capita (15+) in the world",
         y = "Litres of pure alcohol") +
    scale_color_brewer(palette = "Paired") +
    scale_x_continuous(breaks=seq(1960, 2020, 5)) 
```

### Analysis

**Loyal enthusiast**

- Beer: United States, Canada, United Kingdom, Germany, Australia and New Zealand

- Spirits: Russia, Mongolia, China, India and Myanmar

- Wine: France, Italy, Portugal and Argentina

**Replacement**

- Spirits --> Beer *(2000)* : Brazil, Peru and Bolivia

- Wine --> Beer *(1990-2000)* : Turkey, Spain and Algeria

### Differentiate alcohol consumption by gender

```{r}
consumption_g <- read_csv("../clean_data/consumption_gender.csv")

consumption_g[consumption_g == 0] <- NA
```

```{r}
spain_gender <- consumption_g %>%
  filter(Country == "Spain") %>%
  pivot_longer(cols = -c(Country, Gender),
               names_to = "Year",
               values_to = "Litres") %>%
  group_by(Gender, Year) %>%
  na.omit()

  spain_gender %>%
  ggplot(aes(x = Year,
             y = Litres,
             fill = Gender)) +
  labs(title = "Alcohol per capita (15+) consumption in Spain",
       y = "Litres of pure alcohol",
       legend.position='dodge') +
  geom_col() +
  scale_fill_brewer(palette = "BrBG")
  ggplotly()
```

### Trend changes in Spain

- Total alcohol consumption continues to grow after 2010.

- The most popular wine was replaced by beer in 2002.


Cause of Mortality {.tabset}
======================

Column {.tabset} {data-width=650}
-------------------------------------

```{r}
alcohol_cancer <- read.csv("../clean_data/cancer_a_clean.csv")
alcohol_liver <- read.csv("../clean_data/liver_a_clean.csv")
alcohol_traffic <- read.csv("../clean_data/traffic_a_clean.csv")
death_cancer <- read.csv("../clean_data/cancer_d_clean.csv")
death_liver <- read.csv("../clean_data/liver_d_clean.csv")
death_traffic <- read.csv("../clean_data/traffic_d_clean.csv")

alc_cancer_death <- death_cancer %>%
  left_join(alcohol_cancer) %>% 
  mutate(can_alc_death = `cancer.death.population` * `alc.attri.death.cancer`/100) %>% 
  select(Country, gender, can_alc_death)
  
alc_liver_death <- death_liver %>%
  left_join(alcohol_liver) %>% 
  mutate(liver_alc_death = `liver.cirrhosis.death.population` * `alc.attri.death.liver`/100) %>% 
    select(Country, gender, liver_alc_death)

alc_traffic_death <- death_traffic %>%
  left_join(alcohol_traffic) %>% 
  mutate(`alc.attri.death.traffic` = as.numeric(`alc.attri.death.traffic`)) %>% 
    mutate(traffic_alc_death = `road.traffic.death.population` * `alc.attri.death.traffic`/100) %>% 
  select(Country, gender, traffic_alc_death)    

 alc_death <- alc_cancer_death %>% 
  left_join(alc_liver_death) %>% 
  left_join(alc_traffic_death) %>% 
  pivot_longer(cols = c("can_alc_death", "liver_alc_death", "traffic_alc_death"),
               names_to = "cause_of_death",
               values_to = "number_of_death") 

```

### Overview on the alcohol-attributed death

```{r}

 alc_death_sum <- alc_death %>% 
   group_by(Country) %>% 
   summarise(number_of_death = sum(number_of_death))

map_all <- alc_death_sum %>%
  mutate(Country = recode(Country,
                             "Bahamas" = "The Bahamas",
                             "Bolivia (Plurinational State of)" = "clean.htmlBolivia",
                             "Brunei Darussalam" = "Brunei",
                             "Cabo Verde" = "Cape Verde",
                             "Congo" = "Democratic Republic of the Congo",
                             "Czechia" = "Czech Republic",
                             "Democratic People's Republic of Korea" = "North Korea",
                             "Guinea-Bissau" = "Guinea Bissau",
                             "Iran (Islamic Republic of)" = "Iran",
                             "Lao People's Democratic Republic" = "Laos",
                             "Micronesia (Federated States of)" = "Federated States of Micronesia",
                             "North Macedonia" = "Macedonia",
                             "Republic of Korea" = "South Korea",
                             "Republic of Moldova" = "Moldova",
                             "Russian Federation" = "Russia",
                             "Serbia" = "Republic of Serbia",
                             "Syrian Arab Republic" = "Syria",
                             "Timor-Leste" = "East Timor",
                             "United Kingdom of Great Britain and Northern Ireland" = "United Kingdom", 
                             "Venezuela (Bolivarian Republic of)" = "Venezuela",
                             "Viet Nam" = "Vietnam")) 

all_loc <-left_join(Countries, map_all, by = c("admin" = "Country"))
world_points<- st_centroid(all_loc)
world_points <- cbind(all_loc, st_coordinates(st_centroid(all_loc$geometry)))



ui<-fluidPage(
 titlePanel("Number of alcohol-attributed deaths per 100,000 population"),
   mainPanel(plotlyOutput("deathplot"))
 )
 


 server<-function(input,output){
   output$deathplot<-renderPlotly({
     p1 <- ggplot() +
  geom_sf(data = all_loc, mapping = aes(fill = number_of_death))+
  geom_text(data= world_points,aes(x=X, y=Y, label=admin),
    color = "transparent", size = 1, check_overlap = FALSE)+
  scale_fill_distiller(palette = "Spectral", na.value = "white")+
  labs(fill = "") +
  theme_void()+
  theme(panel.grid.major = element_line(colour = "transparent"),
        legend.position = "bottom")
     ggplotly(p1)

   })

 }

 shinyApp(ui = ui, server = server)
```

### Comparison between alcohol-attributed deaths

**Calculation Method:**

- Cancer Death $\times$ Alcohol-Attributed Cancer Death Rate

- Liver Cirrhosis Death $\times$ Alcohol-attributed Liver Cirrhosis Death Rate

- Road Traffic Death $\times$ Alcohol-attributed Road Traffic Death Rate

- Sum up all types of alcohol-attributed deaths


**Analysis:**


- Alcohol causes the highest death rate in *Nigeria* and the lowest in *Lybia*.

- Alcohol brings the highest number of deaths in African countries while the lowest in Middle East countries.


**Possible reasons affecting death rates**

- Religions

In the Middle East and North African areas, most of them are Islam countries which consider drinking alcohol as very serious crimes. For example, in Saudi Arabia, consuming alcohol can bring heavy penalties such as flogging or end up in jail. In addition, the foreigners will get deportation for this. The only way to consume alcohol is from the smugglers or black market. Therefore, religion is a significant reason to the lower alcohol-attributed death rate.

- Income 

Based on the table and the map, it is found that the lower income countries such as South Africa has the highest number of alcohol-attributed death. For instance, in Tanzania, there is an unauthorized locally produced low quality beverage called Congo. This drink has been proven to be very harmful to human body, however there are great amount of consumption because of its extremely low price. Moreover, as the price of Congo is even lower than food, the jobless people in Tanzania tend to consume alcohol instead of food and got addicted to alcohol. And evtually drink themselves to death. 


- Education 

On the other hand, the high income countries are found with the lowest number of death. Based on the study in 'Literacy and economy', literacy was found positively related to the income. For example, Japan is a high income country, there are educations in the harmfulness on alcohol from primary school. Therefore, people are less likely to suffer from excessive drinking.




Column {.tabset} {data-width=350}
-------------------------------------

### Total number of alcohol attributed death

```{r fig.height=4 ,fig.width=2}

overview <- alc_death %>% 
  group_by(gender, cause_of_death) %>%  
  ggplot(aes(x = cause_of_death,
             y = number_of_death,
             fill = gender))+
    geom_col(position = "dodge")+
    theme_bw() 
ggplotly(overview)

```

### Alcohol-Attributed Death VS Road Traffic death (By Income Level)

```{r }

alc_death %>%
  left_join(Countries, by = c("Country" = "admin")) %>% 
  mutate(income_grp = recode(income_grp,
                            `2. High income: nonOECD` = "high",
                            `5. Low income` = "low",
                            `3. Upper middle income` =  "upper_middle",
                            `4. Lower middle income` =  "lower_middle",
                            `1. High income: OECD` = "high")) %>%
  group_by(Country, income_grp, gender) %>%
  summarise(alc_death = sum(number_of_death)) %>% 
  left_join(death_traffic) %>% 
  drop_na() %>% 
  rename("traffic_death" = `road.traffic.death.population`) %>% 
    group_by(income_grp) %>% 
  summarise(alc_death = mean(alc_death),
            traffic_death = mean(traffic_death))%>%    
  arrange(desc(alc_death)) %>%
  kable(align = "c", col.names = c("income group",
                           "alcohol-attribute death", "road traffic death")) %>% 
  kable_styling("striped","hover")
  
```

### Comparison between total alcohol-attributed deaths and traffic deaths

**Harms of alcohol**

- Cancer

- Liver Cirrhosis

- Road traffic accidents

**Calculation method: **

- Average number of deaths(per 100,000 population) in each continent.


**Analysis:**

- Alcohol causes more deaths to *Males*.

- *Liver Cirrhosis* causes the highest death rate while *Road Traffic Accidents* causes the lowest.

Policy Pattern {.tabset}
======================

Column {.tabset} {data-width = 400}
------------------------
### Infographic of Policies

```{r read_data}
policy_pattern <- read_csv("../clean_data/policy_pattern.csv")
consumption_pattern <- read_csv("../clean_data/consumption_pattern.csv")
```

```{r}

policy_country_group <- policy_pattern %>%
  pivot_longer(cols = c("2010", "2011", "2012", "2013", "2014","2015", "2016"),
               names_to = "Year",
               values_to = "Action")

cities <- data.frame(world.cities) %>%
  filter(capital == 1)

world <- map_data("world") %>%
  mutate(Country = region) %>%
  select(long,lat,region)

policy_country_group_map <- policy_country_group %>%
  left_join(cities, by = c("Country" = "country.etc")) %>%
  na.omit() %>%
  select(Country,`Action Area`,Action,lat,long,name,Year)
```

```{r}
ui <- bootstrapPage(tags$style(type = "text/css", "html, body, .leaflet {width:100%; height:100%}"),
                    leafletOutput("map", width = "100%", height = "100%"),
                    # position and properties of the time slider
                    absolutePanel(top = 10, right = 10, draggable = TRUE,
                                  # slider title, step increments, and ticks
                                  sliderInput("integer", "Year", min = 2010, max = 2016, value = 2010, step = 1,ticks = FALSE, width = '100px', sep = "",
                                              animate =
                                                  animationOptions(interval = 4000, loop = TRUE))))

# shiny server input/output
server <- function(input, output, session) {
    filteredData <- reactive({
        policy_country_group_map %>%
            filter(Year == input$integer)
    })
    output$map <- renderLeaflet({
        leaflet(world) %>%
            addProviderTiles(providers$CartoDB.Positron) %>%
            # set boundaries for map
            fitBounds(lng1 = min(world$long),
                      lat1 = min(world$lat),
                      lng2 = max(world$long),
                      lat2 = max(world$lat))
    })
    observe({
        leafletProxy("map", data = filteredData()) %>%
            clearMarkers() %>%
            addMarkers(~long, ~lat, popup = ~as.character(Action), label = ~as.character(`Action Area`))
    })
}
shinyApp(ui=ui, server=server, options = list(height = 500), enableBookmarking = "server")
```


### Effectiveness of Policy Actions

```{r}
consumption_pattern_filter <- consumption_pattern %>%
  filter(`Beverage Types` == "All types") %>%
  select(-`Beverage Types`) %>%
  pivot_longer(cols = -c("Country"), names_to = "Year", values_to = "Per Capita Alcohol Consumed") %>%
  left_join(policy_country_group) %>%
  filter(`Per Capita Alcohol Consumed` > 0) %>%
  group_by(Country) %>%
  arrange(Year, .by_group = TRUE)

df <- data.frame(row_no=numeric())
consumption_pattern_filter$row_no <- seq.int(nrow(consumption_pattern_filter)) 

finaltbl <- consumption_pattern_filter %>%
  na.omit() %>%
  mutate(row_no2 = row_no + 1)

addtbl <- finaltbl %>%
  select(row_no2) %>%
  left_join(consumption_pattern_filter) %>%
  filter(row_no == row_no2) %>%
  select(-c(row_no,row_no2))

finaltbl <- finaltbl %>%
  select(-c(row_no,row_no2))
  

tbl1 <- rbind(addtbl,finaltbl) %>%
  arrange(Country, Year)

tbl <- tbl1 %>%
  distinct(`Per Capita Alcohol Consumed`, .keep_all = TRUE) %>%
  select(Year, `Per Capita Alcohol Consumed`)

```



```{r}

lag_tbl <- lag(tbl) %>%
  select(Country, Year, `Per Capita Alcohol Consumed`) %>%
  mutate(alc_diff = `Per Capita Alcohol Consumed`) %>%
  cbind(tbl) %>%
   transmute(Country = Country...5, Year = Year...6, `Per Capita Alcohol Consumed` = `Per Capita Alcohol Consumed...7`,alc_diff = alc_diff)
 for (i in 1:452) {
   ifelse(lag_tbl$Country[i] == lag_tbl$Country[i+1],
          next,
          lag_tbl$alc_diff[i+1] <- NA)
 }
lag_tbl <- lag_tbl %>%
  mutate(Year = as.numeric(Year)-1)

lag_tbl <- lag_tbl %>%
   mutate(alc_diff_2= (`Per Capita Alcohol Consumed` - alc_diff)/alc_diff*100) %>%
   filter(!is.na(alc_diff_2)) %>%
   mutate(Trend = ifelse(alc_diff_2<=0,"Reducing","Increasing"))

tbl1 <- tbl1 %>%
  mutate(Year = as.numeric(Year)) %>%
  select(-`Per Capita Alcohol Consumed`)

check_tbl <- full_join(lag_tbl,tbl1) %>%
  arrange(Country, Year) %>%
  na.omit() %>%
  unique()

fin_tbl <- check_tbl %>%
   group_by(Year,`Action Area`, Trend) %>%
   tally() %>%
  mutate(Year = as.character(Year))

p2 <- fin_tbl %>%
  ggplot(aes(y = Year, x= n,fill = Trend)) +
  facet_wrap(~`Action Area`, labeller = labeller(`Action Area` = label_wrap_gen(70)), ncol = 2) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(strip.background = element_rect(colour = "white", fill = "white"), strip.text.x = element_text(size=6, color = "black", face = "bold"), axis.text.y = element_text(angle = 5, hjust = 1, size = 6), axis.title.x = element_text(size=9)) +
  labs(x = "Number of Countries")

ggplotly(p2)
```



Column {.tabset} {data-width = 650}
------------------------------------

### Policies being favored by countries across years 2010-2016

```{r}
policy_country_group_plot <- check_tbl %>%
  na.omit() %>%
  group_by(`Action Area`,Year) %>%
  tally() %>%
  arrange(Year)


p <- policy_country_group_plot %>%
  ggplot(aes(x=Year,y=n, group = `Action Area`)) +
  geom_line(aes(color = `Action Area`)) +
  geom_point() +
  labs(y = "Number of Countries") +
  theme_bw() +
  theme(legend.position = "left", legend.text = element_text(size = 7)) 
ggplotly(p) %>%
  layout(legend = list(x = 0,
                     y = 1,
                     tracegroupgap = 0))
```



### Analysis

```{r}
act_area <-  length(unique(policy_country_group$`Action Area`))
```

- There are `r act_area` main areas of Policy Actions that the effectiveness are measured for.
From the figure of Policies favored across countries from the years 2010-2016, it is visible that 'Leadership, awareness and commitment' policies are the ones that are being favored by most countries.
```{r}
df <- check_tbl %>%
  arrange(alc_diff_2)
df <- head(df,10) %>%
  filter(str_detect(`Action Area`,"Leadership")) %>%
  tally() %>%
  length()
```

- Upon checking the largest percentage decrease in per capita alcohol consumption it is visible that this policy has only `r df` entry which has resulted in a decrease.
```{r}
df <- check_tbl %>%
  arrange(desc(alc_diff_2))
df <- head(df,10) %>%
  filter(str_detect(`Action Area`,"Leadership")) %>%
  tally()
```

- However upon checking the largest percentage increase in per capita alcohol consumption it is visible that this policy has `r df[1]` entries.
- This shows that the governments are not taking the efficient route.
```{r}
df <- check_tbl %>%
  group_by(`Action Area`) %>%
  summarise(mean = mean(alc_diff_2)) %>%
  arrange(mean)

kbl(df) %>%
  kable_minimal(font_size = 9) %>%
  row_spec(1, bold = T) %>%
  row_spec(10, bold = T)
```
- From the table we can see that the most efficient action area seems to be - `r paste(df$'Action Area'[1])`
- While the least efficient area is - `r paste(df$'Action Area'[10])`
- One area of relief is that the second most efficent action area i.e., `r paste(df$'Action Area'[2])`, is also the second most used strategy by countries across the world.
```{r}
df1 <- check_tbl %>%
  filter(alc_diff_2 == min(alc_diff_2))
df2 <- check_tbl %>%
  filter(alc_diff_2 == max(alc_diff_2))
```

> The biggest dip in consumption was seen in `r paste(df1$Country[1])` in the year `r paste(df1$Year[1])` after the step - `r paste(df1$Action[1])` The policy area for this is - `r paste(df1$'Action Area'[1])`. There was a dip in consumption by `r paste(df1$alc_diff_2[1])`%.

> The biggest spike in consumption was seen in `r paste(df2$Country[1])` in the year `r paste(df2$Year[1])` within the policy area - `r paste(df2$'Action Area'[1])`. There was a spike in consumption by `r paste(df2$alc_diff_2[1])`%. Bhutan's alcoholism is an issue that has been noted and despite efforts there seems to be no solution yet.

-------------------

Age Restrictions {.tabset}
======================

```{r}
BAC_limits_tidy <- read_csv(here::here("clean_data/BAC_limits_tidy.csv"))
Age_limits_tidy <- read_csv(here::here("clean_data/Age_limits_tidy.csv"))
current_drinkers_15_19_tidy <- read_csv(here::here("clean_data/current_drinkers_15_19_tidy.csv"))
heavy_drinkers_15_19_tidy <- read_csv(here::here("clean_data/heavy_drinkers_15_19_tidy.csv"))
```

```{r}
limits <- BAC_limits_tidy %>% 
  left_join(Age_limits_tidy) %>% 
  left_join(current_drinkers_15_19_tidy) %>% 
  left_join(heavy_drinkers_15_19_tidy) %>% 
  rename("Age_limit" = limit)
limits1 <- limits %>% 
  mutate(Age_limit = tolower(Age_limit),
         BAC_limits = tolower(BAC_limits)) %>% 
  filter(gender == "All") %>% 
  filter(!str_detect(Age_limit, "no data"),
         !str_detect(Service, "service")) %>% 
  mutate(Age_limit = ifelse(Age_limit == "total ban", "99", Age_limit), 
         Age_limit = ifelse(Age_limit == "none", "0", Age_limit),
         Age_limit = ifelse(Age_limit == "subnational", "18", Age_limit)) %>% 
  mutate(Age_limit = as.numeric(Age_limit)) %>% 
  mutate(country = ifelse(country == "Russian Federation", "Russia", country),
         country = ifelse(country == "Iran (Islamic Republic of)", "Iran", country),
         country = ifelse(country == "United States of America", "USA", country),
         country = ifelse(country == "Venezuela (Bolivarian Republic of)", "Venezuela", country),
         country = ifelse(country == "Viet Nam", "Vietnam", country),
         country = ifelse(country == "United Kingdom of Great Britain and Northern Ireland", "UK", country),
         country = ifelse(country == "Czechia", "Czech Republic", country),
         country = ifelse(country == "Congo", "Democratic Republic of the Congo", country),
         country = ifelse(country == "United Republic of Tanzania", "Tanzania", country))

limits2 <- limits1 %>% 
  group_by(country) %>% 
  summarise(Age_limit = min(Age_limit)) 
  
limits_tidy <- limits1 %>% 
  select(country, BAC_limits, drinker_percentage, heavy_drinker_percentage) %>% 
  group_by(country) %>% 
  distinct() %>% 
  full_join(limits2) %>% 
  mutate(BAC_limits = factor(BAC_limits, 
                            levels = c("none", "0.08%", "0.07%", "0.06%", "0.05%", "0.04%", "0.03%", "0.02%", "0.01%", "zero tolerance", "total ban"))) %>% 
  mutate(Age_limit = factor(Age_limit, 
                            levels = as.character(c("0", "16", "17", "18", "20", "21", "25", "99")))) %>% 
  rename("drinker_rate" = drinker_percentage,
         "heavy_rate" = heavy_drinker_percentage)
```

Column {data-width=650}
---------------------------


### table


```{r}
limits_tidy %>% 
  ungroup() %>%
  summarise(mean_drinker_rate = mean(drinker_rate),
            mean_heavy_rate = mean(heavy_rate)) %>% 
  kable(caption = "Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```



### map

```{r}
world_map <- map_data("world") %>%
  right_join(limits_tidy, 
            by = c("region" = "country")) %>%
  select(-subregion)
worldMaps <- function(data_type){
if(data_type == "drinker_rate") 
  {
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = drinker_rate), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  
  
}
  else if(data_type == "heavy_rate") {
    
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = heavy_rate), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  
  
  }
  else if(data_type == "BAC_limits") {
    
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = BAC_limits), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  
  }
  else {
    
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = Age_limit), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  }
  return(p)
  #ggplotly(p)
}
```


```{r}
ui <- fluidPage(
    selectInput("variable", "Variable:",
                c("drinker_rate" = "drinker_rate", "heavy_rate" = "heavy_rate", "Age_limit" = "Age_limit", "BAC_limits" = "BAC_limits")),
    mainPanel(plotOutput(outputId = "plot_output"))
  )
server <- function(input,output,session) {
    output$plot_output <- renderPlot({
      worldMaps(input$variable)
    })
  }
shinyApp(ui=ui, server=server, options = list(height = 500), enableBookmarking = "server")
```





Column {data-width=350}
---------------------------


### Analysis
  
* Based on 15-19 years old adolescents  
* Youth drinker mean percentage across world: 31.2%  
* Youth heavy drinker mean percentage  
(Based on drinkers) across world: 48.5%  
* Roughly high rate  
  
    
    
* Low rate of drinkers:  
**The Middle East** & **North Africa**    
  
* High rate of drinkers:  
**USA** & **Argentina** & **Australia** & **European countries** 
  
* Possible reasons:  
  + Low rate   
    - Age restriction: "Total Ban"   
    - Religion: Islam (Alcohol Forbidden)  
  + High rate
    - Rich drinking culture
    - Rich in wine
      
* Low rate of heavy drinkers: 
**The Middle East** & **North Africa**     
    
* High rate of heavy drinkers:  
**Russia** & **West Africa**
   
* Possible reasons:    
  + Low rate 
    - Same as above   
  + High rate  
    - BAC restriction: more relaxed  
    - Economic depression  
    - Drinking culture  
    - National character  
    - Natural cold  




Youth Inebriation {.tabset}
======================

```{r}
at_least_once_a_week_tidy <- read_csv(here::here("clean_data/at_least_once_a_week_tidy.csv"))
first_drink_earlier_than_13_tidy <- read_csv(here::here("clean_data/first_drink_earlier_than_13_tidy.csv"))
any_alcohol_in_past_12_months_tidy <- read_csv(here::here("clean_data/any_alcohol_in_past_12_months_tidy.csv"))
any_alcohol_in_past_30_days_tidy <- read_csv(here::here("clean_data/any_alcohol_in_past_30_days_tidy.csv"))
```

```{r}
youth_drinking1 <- first_drink_earlier_than_13_tidy %>% 
  filter(!gender == "All") %>% 
  full_join(at_least_once_a_week_tidy, 
            by = c("country", "year", "gender")) %>% 
  rename("first_drink_earlier_than_13_percentage" = percentage.x,
         "at_least_once_a_week_percentage" = percentage.y) %>% 
  filter(!is.na(first_drink_earlier_than_13_percentage),
         !is.na(at_least_once_a_week_percentage)) %>% 
  group_by(country, gender) %>%
  summarise(first_drink_earlier_than_13_mean = mean(first_drink_earlier_than_13_percentage),
            at_least_once_a_week_mean = mean(at_least_once_a_week_percentage))

```


```{r}
youth_drinking2 <- any_alcohol_in_past_12_months_tidy %>% 
  filter(!str_detect(gender, "All"),
         !is.na(percentage)) %>% 
  group_by(country, gender) %>% 
  summarise(any_alcohol_in_past_12_months_mean = mean(percentage))

youth_drinking3 <- any_alcohol_in_past_30_days_tidy %>% 
  filter(!str_detect(gender, "All"),
         !is.na(percentage)) %>% 
  group_by(country, gender) %>% 
  summarise(any_alcohol_in_past_30_days_mean = mean(percentage))
```

```{r}
youth_drinking <- youth_drinking1 %>% 
  left_join(youth_drinking2) %>%
  left_join(youth_drinking3) %>% 
  filter(!is.na(any_alcohol_in_past_12_months_mean),
         !is.na(any_alcohol_in_past_30_days_mean)) %>% 
  select(-first_drink_earlier_than_13_mean) %>% 
  pivot_longer(cols = -c(country, gender),
               names_to = "frequency",
               values_to = "percentage") %>%
  mutate(country = ifelse(country == "United Kingdom of Great Britain and Northern Ireland", "UK", country),
         country = ifelse(country == "United States of America", "USA", country),
         country = ifelse(country == "Russian Federation", "Russia", country))

youth_drinking$frequency <- factor(youth_drinking$frequency, levels = c("at_least_once_a_week_mean", "any_alcohol_in_past_30_days_mean", "any_alcohol_in_past_12_months_mean"))
```

Column 
---------------------------

### Barplot

```{r, fig.height=6}
freq <- youth_drinking %>% 
  ggplot(aes(x = percentage,
             y = reorder(country, desc(percentage)),
             fill = gender,
             text = country)) +
  geom_col() +
  facet_grid(~frequency, scales = "free_x") +
  theme_bw() + 
  scale_fill_brewer(palette = "Paired")

ggplotly(freq)
```

  
 


### Analysis  
  
* Based on 15-year-old adolescents & mainly based in Europe  
* Low frequency:  
**Northern Europe**  
* High frequency:  
**Malta** & **Czech** & **Denmark** & **Austria** etc.    
* Possible reasons:  
  + Good taste   
  + Low price   
* Examples: (According to a European study *ESPAD*)       
  + Danish children: most enthusiastic drinkers  
  + Icelandic teenagers: not being attracted to addictive substances  



Limitations {.tabset} 
======================

Column {.tabset}
---------------------------
### Popularity

#### Conclusion

- Global alcohol consumption continues to grow, and the most popular one is beer.

- South America, Brazil, Peru and Bolivia which were most interested in spirits at the beginning, were replaced by beer in around 2000.

- Wine was most popular in Turkey, Spain, and Algeria, but it was replaced by beer from 1990 to 2000.

- For countries where wine and spirits were the most popular alcohol types at the beginning, these two types of alcohol have been replaced by beer to varying degrees.

---------------------------
#### Limitations

1. Since Unrecorded consumption data only has data for one year in 2019, there is no way to combine it with the recorded data to get more accurate results.
2. The data in the early years is relatively incomplete.
3. Some countries have data interruptions for several consecutive years.

### Cause of Mortality

1. There can be unidentified alcohol-attributed deaths.
2. It contains only 2016 data that may cause limitations in explaining the situation.
3. There are missing data in some areas that would affect the accuracy of the analysis.

### Policy Patterns

1. The values for each policy area have not been weighted by importance.
2. Data is not available for a large number of countries so the analysis has been performed on the limited data set given.
3. This analysis has only been limited between the years of 2010-2016.
4. There could be population/age bias as demographic data is unavailable.



### Age Restrictions

1. Only data in 2016 is included in the dataset.
2. There are several countries with NAs in either age or BAC limits.  
3. Many other factors affect adolescent drinking.  

### Youth Inebriation

1. Only 15-year-olds were analyzed.  
2. Each set of data has only a few years.  
3. Only part of countries are included in dataset.


References {.tabset}
======================

GHO | global information system on alcohol and Health (gisah) | global information system on alcohol and health. (n.d.). Retrieved May 09, 2021, from https://apps.who.int/gho/data/node.gisah.GISAH?lang=en&amp;showonly=GISAH

Need to control alcohol consumption. (2017, January 24). Retrieved May 15, 2021, from https://kuenselonline.com/need-to-control-alcohol-consumption/

Writer, S. (2019, August 10). South Africa has some of the heaviest drinkers in the world. Retrieved May 20, 2021, from https://businesstech.co.za/news/lifestyle/332909/south-africa-has-some-of-the-heaviest-drinkers-in-the-world/

(www.dw.com), D. W. (2015, January 05). Tanzania mulls action on alcohol misuse: DW: 05.01.2015. Retrieved May 20, 2021, from https://www.dw.com/en/tanzania-mulls-action-on-alcohol-misuse/a-18171168

Meltzer, M. (2019, March 18). Your guide to drinking laws in the Arab world. Retrieved May 20, 2021, from https://matadornetwork.com/read/drinking-laws-arab-world/

Drucker, D. P., Mutumbuka, D., & V, G. (2015, November 26). Literacy & the Economy. Retrieved May 20, 2021, from http://www.read.org.za/useful-info/literacy-the-economy/

  Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686,
  https://doi.org/10.21105/joss.01686
  
  Original S code by Richard A. Becker, Allan R. Wilks. R version by Ray Brownrigg. Enhancements by Thomas P
  Minka and Alex Deckmyn. (2018). maps: Draw Geographical Maps. R package version 3.3.0.
  https://CRAN.R-project.org/package=maps
  
    C. Sievert. Interactive Web-Based Data Visualization with R, plotly, and shiny. Chapman and Hall/CRC Florida,
  2020.
  
   Richard Iannone, JJ Allaire and Barbara Borges (2020). flexdashboard: R Markdown Format for Flexible
  Dashboards. R package version 0.5.2. https://CRAN.R-project.org/package=flexdashboard
  
    Hao Zhu (2021). kableExtra: Construct Complex Table with 'kable' and Pipe Syntax. R package version 1.3.4.
  https://CRAN.R-project.org/package=kableExtra
  
   Andy South (2017). rnaturalearth: World Map Data from Natural Earth. R package version 0.1.0.
  https://CRAN.R-project.org/package=rnaturalearth

 Erich Neuwirth (2014). RColorBrewer: ColorBrewer Palettes. R package version 1.1-2.
  https://CRAN.R-project.org/package=RColorBrewer
  
   Pebesma, E., 2018. Simple Features for R: Standardized Support for Spatial Vector Data. The R Journal 10 (1),
  439-446, https://doi.org/10.32614/RJ-2018-009

 Simon Garnier, Noam Ross, Robert Rudis, AntÃ´nio P. Camargo, Marco Sciaini, and CÃ©dric Scherer (2021). Rvision
  - Colorblind-Friendly Color Maps for R. R package version 0.6.0.
  
    Joe Cheng, Bhaskar Karambelkar and Yihui Xie (2021). leaflet: Create Interactive Web Maps with the JavaScript
  'Leaflet' Library. R package version 2.0.4.1. https://CRAN.R-project.org/package=leaflet

  Hadley Wickham (2019). stringr: Simple, Consistent Wrappers for Common String Operations. R package version
  1.4.0. https://CRAN.R-project.org/package=stringr
  
    Winston Chang, Joe Cheng, JJ Allaire, Carson Sievert, Barret Schloerke, Yihui Xie, Jeff Allen, Jonathan
  McPherson, Alan Dipert and Barbara Borges (2021). shiny: Web Application Framework for R. R package version
  1.6.0. https://CRAN.R-project.org/package=shiny

  Baptiste Auguie (2017). gridExtra: Miscellaneous Functions for "Grid" Graphics. R package version 2.3.
  https://CRAN.R-project.org/package=gridExtra

  David Gohel and Panagiotis Skintzos (2021). ggiraph: Make 'ggplot2' Graphics Interactive. R package version
  0.7.9. https://CRAN.R-project.org/package=ggiraph
  
    Thomas Lin Pedersen and David Robinson (2020). gganimate: A Grammar of Animated Graphics. R package version
  1.0.7. https://CRAN.R-project.org/package=gganimate
  
    Nicholas Tierney, Di Cook, Miles McBain and Colin Fay (2020). naniar: Data Structures, Summaries, and
  Visualisations for Missing Data. R package version 0.6.0. https://CRAN.R-project.org/package=naniar
