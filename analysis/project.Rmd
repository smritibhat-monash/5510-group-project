---
title: "Alcohol Consumption Patterns"
output:
  flexdashboard::flex_dashboard:
    theme: bootstrap
    vertical_layout: scroll
    runtime: shiny
---
   

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(knitr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(maps)
library(plotly)
library(flexdashboard)
library(kableExtra)
library(leaflet)
library(stringr)
library(shiny)
library(gridExtra)
library(ggiraph)
```

Introduction {.tabset}
======================




Column {data-width=800}
-------------------------------------

### Background




Column {data-width=200}
-------------------------------------

   
### Approach of Project

The report will be collating specific sections of this data pertaining to countrywise policy responses, consumption pattern, youth and alcohol, levels of consumption and harms and consequences.

### Information on Data

This report is being created using the data from the GISAH (Global Information System on Alcohol and Health) tool of the World Health Organisation. GISAH tool helps monitor trends relating to alcohol consumption across various age groups, side effects (harm caused) as well as the policy responses by different countries.

### Makers

**Team Name: Hayaku**

_Researchers:_

- _Kexin Xu_
- _Smriti Vinayak Bhat_
- _Yalong liu_
- _Yin Shan Ho_


Popularity {.tabset}
======================


Cause of Mortality {.tabset}
======================

Policy Pattern {.tabset}
======================

Column {.tabset} {data-width = 400}
------------------------
### Infographic of Policies

```{r read_data}
policy_pattern <- read_csv("../clean_data/policy_pattern.csv")
consumption_pattern <- read_csv("../clean_data/consumption_pattern.csv")
```

```{r}

policy_country_group <- policy_pattern %>%
  pivot_longer(cols = c("2010", "2011", "2012", "2013", "2014","2015", "2016"),
               names_to = "Year",
               values_to = "Action")

cities <- data.frame(world.cities) %>%
  filter(capital == 1)

world <- map_data("world") %>%
  mutate(Country = region) %>%
  select(long,lat,region)

policy_country_group_map <- policy_country_group %>%
  left_join(cities, by = c("Country" = "country.etc")) %>%
  na.omit() %>%
  select(Country,`Action Area`,Action,lat,long,name,Year)
```

```{r}
ui <- bootstrapPage(tags$style(type = "text/css", "html, body, .leaflet {width:100%; height:100%}"),
                    leafletOutput("map", width = "100%", height = "100%"),
                    # position and properties of the time slider
                    absolutePanel(top = 10, right = 10, draggable = TRUE,
                                  # slider title, step increments, and ticks
                                  sliderInput("integer", "Year", min = 2010, max = 2016, value = 2010, step = 1,ticks = FALSE, width = '100px', sep = "",
                                              animate =
                                                  animationOptions(interval = 4000, loop = TRUE))))

# shiny server input/output
server <- function(input, output, session) {
    filteredData <- reactive({
        policy_country_group_map %>%
            filter(Year == input$integer)
    })
    output$map <- renderLeaflet({
        leaflet(world) %>%
            addProviderTiles(providers$CartoDB.Positron) %>%
            # set boundaries for map
            fitBounds(lng1 = min(world$long),
                      lat1 = min(world$lat),
                      lng2 = max(world$long),
                      lat2 = max(world$lat))
    })
    observe({
        leafletProxy("map", data = filteredData()) %>%
            clearMarkers() %>%
            addMarkers(~long, ~lat, popup = ~as.character(Action), label = ~as.character(`Action Area`))
    })
}
shinyApp(ui=ui, server=server, options = list(height = 500), enableBookmarking = "server")
```


### Effectiveness of Policy Actions

```{r}
consumption_pattern_filter <- consumption_pattern %>%
  filter(`Beverage Types` == "All types") %>%
  select(-`Beverage Types`) %>%
  pivot_longer(cols = -c("Country"), names_to = "Year", values_to = "Per Capita Alcohol Consumed") %>%
  left_join(policy_country_group) %>%
  filter(`Per Capita Alcohol Consumed` > 0) %>%
  group_by(Country) %>%
  arrange(Year, .by_group = TRUE)

df <- data.frame(row_no=numeric())
consumption_pattern_filter$row_no <- seq.int(nrow(consumption_pattern_filter)) 

finaltbl <- consumption_pattern_filter %>%
  na.omit() %>%
  mutate(row_no2 = row_no + 1)

addtbl <- finaltbl %>%
  select(row_no2) %>%
  left_join(consumption_pattern_filter) %>%
  filter(row_no == row_no2) %>%
  select(-c(row_no,row_no2))

finaltbl <- finaltbl %>%
  select(-c(row_no,row_no2))
  

tbl1 <- rbind(addtbl,finaltbl) %>%
  arrange(Country, Year)

tbl <- tbl1 %>%
  distinct(`Per Capita Alcohol Consumed`, .keep_all = TRUE) %>%
  select(Year, `Per Capita Alcohol Consumed`)

```



```{r}

lag_tbl <- lag(tbl) %>%
  select(Country, Year, `Per Capita Alcohol Consumed`) %>%
  mutate(alc_diff = `Per Capita Alcohol Consumed`) %>%
  cbind(tbl) %>%
   transmute(Country = Country...5, Year = Year...6, `Per Capita Alcohol Consumed` = `Per Capita Alcohol Consumed...7`,alc_diff = alc_diff)
 for (i in 1:452) {
   ifelse(lag_tbl$Country[i] == lag_tbl$Country[i+1],
          next,
          lag_tbl$alc_diff[i+1] <- NA)
 }
lag_tbl <- lag_tbl %>%
  mutate(Year = as.numeric(Year)-1)

lag_tbl <- lag_tbl %>%
   mutate(alc_diff_2= (`Per Capita Alcohol Consumed` - alc_diff)/alc_diff*100) %>%
   filter(!is.na(alc_diff_2)) %>%
   mutate(Trend = ifelse(alc_diff_2<=0,"Reducing","Increasing"))

tbl1 <- tbl1 %>%
  mutate(Year = as.numeric(Year)) %>%
  select(-`Per Capita Alcohol Consumed`)

check_tbl <- full_join(lag_tbl,tbl1) %>%
  arrange(Country, Year) %>%
  na.omit() %>%
  unique()

fin_tbl <- check_tbl %>%
   group_by(Year,`Action Area`, Trend) %>%
   tally() %>%
  mutate(Year = as.character(Year))

p2 <- fin_tbl %>%
  ggplot(aes(y = Year, x= n,fill = Trend)) +
  facet_wrap(~`Action Area`, labeller = labeller(`Action Area` = label_wrap_gen(70)), ncol = 2) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(strip.background = element_rect(colour = "white", fill = "white"), strip.text.x = element_text(size=6, color = "black", face = "bold"), axis.text.y = element_text(angle = 5, hjust = 1, size = 6), axis.title.x = element_text(size=9)) +
  labs(x = "Number of Countries")

ggplotly(p2)
```



Column {.tabset} {data-width = 650}
------------------------------------

### Policies being favored by countries across years 2010-2016

```{r}
policy_country_group_plot <- check_tbl %>%
  na.omit() %>%
  group_by(`Action Area`,Year) %>%
  tally() %>%
  arrange(Year)


p <- policy_country_group_plot %>%
  ggplot(aes(x=Year,y=n, group = `Action Area`)) +
  geom_line(aes(color = `Action Area`)) +
  geom_point() +
  labs(y = "Number of Countries") +
  theme_bw() +
  theme(legend.position = "left", legend.text = element_text(size = 7)) 
ggplotly(p) %>%
  layout(legend = list(x = 0,
                     y = 1,
                     tracegroupgap = 0))
```



### Analysis

```{r}
act_area <-  length(unique(policy_country_group$`Action Area`))
```

- There are `r act_area` main areas of Policy Actions that the effectiveness are measured for.
From the figure of Policies favored across countries from the years 2010-2016, it is visible that 'Leadership, awareness and commitment' policies are the ones that are being favored by most countries.
```{r}
df <- check_tbl %>%
  arrange(alc_diff_2)
df <- head(df,10) %>%
  filter(str_detect(`Action Area`,"Leadership")) %>%
  tally() %>%
  length()
```

- Upon checking the largest percentage decrease in per capita alcohol consumption it is visible that this policy has only `r df` entry which has resulted in a decrease.
```{r}
df <- check_tbl %>%
  arrange(desc(alc_diff_2))
df <- head(df,10) %>%
  filter(str_detect(`Action Area`,"Leadership")) %>%
  tally()
```

- However upon checking the largest percentage increase in per capita alcohol consumption it is visible that this policy has `r df[1]` entries.
- This shows that the governments are not taking the efficient route.
```{r}
df <- check_tbl %>%
  group_by(`Action Area`) %>%
  summarise(mean = mean(alc_diff_2)) %>%
  arrange(mean)

kbl(df) %>%
  kable_minimal(font_size = 9) %>%
  row_spec(1, bold = T) %>%
  row_spec(10, bold = T)
```
- From the table we can see that the most efficient action area seems to be - `r paste(df$'Action Area'[1])`
- While the least efficient area is - `r paste(df$'Action Area'[10])`
- One area of relief is that the second most efficent action area i.e., `r paste(df$'Action Area'[2])`, is also the second most used strategy by countries across the world.
```{r}
df1 <- check_tbl %>%
  filter(alc_diff_2 == min(alc_diff_2))
df2 <- check_tbl %>%
  filter(alc_diff_2 == max(alc_diff_2))
```

> The biggest dip in consumption was seen in `r paste(df1$Country[1])` in the year `r paste(df1$Year[1])` after the step - `r paste(df1$Action[1])` The policy area for this is - `r paste(df1$'Action Area'[1])`. There was a dip in consumption by `r paste(df1$alc_diff_2[1])`%.

> The biggest spike in consumption was seen in `r paste(df2$Country[1])` in the year `r paste(df2$Year[1])` within the policy area - `r paste(df2$'Action Area'[1])`. There was a spike in consumption by `r paste(df2$alc_diff_2[1])`%. Bhutan's alcoholism is an issue that has been noted and despite efforts there seems to be no solution yet.

-------------------

Age Restrictions {.tabset}
======================

```{r}
BAC_limits_tidy <- read_csv(here::here("clean_data/BAC_limits_tidy.csv"))
Age_limits_tidy <- read_csv(here::here("clean_data/Age_limits_tidy.csv"))
current_drinkers_15_19_tidy <- read_csv(here::here("clean_data/current_drinkers_15_19_tidy.csv"))
heavy_drinkers_15_19_tidy <- read_csv(here::here("clean_data/heavy_drinkers_15_19_tidy.csv"))
```

```{r}
limits <- BAC_limits_tidy %>% 
  left_join(Age_limits_tidy) %>% 
  left_join(current_drinkers_15_19_tidy) %>% 
  left_join(heavy_drinkers_15_19_tidy) %>% 
  rename("Age_limit" = limit)
limits1 <- limits %>% 
  mutate(Age_limit = tolower(Age_limit),
         BAC_limits = tolower(BAC_limits)) %>% 
  filter(gender == "All") %>% 
  filter(!str_detect(Age_limit, "no data"),
         !str_detect(Service, "service")) %>% 
  mutate(Age_limit = ifelse(Age_limit == "total ban", "99", Age_limit), 
         Age_limit = ifelse(Age_limit == "none", "0", Age_limit),
         Age_limit = ifelse(Age_limit == "subnational", "18", Age_limit)) %>% 
  mutate(Age_limit = as.numeric(Age_limit)) %>% 
  mutate(country = ifelse(country == "Russian Federation", "Russia", country),
         country = ifelse(country == "Iran (Islamic Republic of)", "Iran", country),
         country = ifelse(country == "United States of America", "USA", country),
         country = ifelse(country == "Venezuela (Bolivarian Republic of)", "Venezuela", country),
         country = ifelse(country == "Viet Nam", "Vietnam", country),
         country = ifelse(country == "United Kingdom of Great Britain and Northern Ireland", "UK", country),
         country = ifelse(country == "Czechia", "Czech Republic", country),
         country = ifelse(country == "Congo", "Democratic Republic of the Congo", country),
         country = ifelse(country == "United Republic of Tanzania", "Tanzania", country))

limits2 <- limits1 %>% 
  group_by(country) %>% 
  summarise(Age_limit = min(Age_limit)) 
  
limits_tidy <- limits1 %>% 
  select(country, BAC_limits, drinker_percentage, heavy_drinker_percentage) %>% 
  group_by(country) %>% 
  distinct() %>% 
  full_join(limits2) %>% 
  mutate(BAC_limits = factor(BAC_limits, 
                            levels = c("none", "0.08%", "0.07%", "0.06%", "0.05%", "0.04%", "0.03%", "0.02%", "0.01%", "zero tolerance", "total ban"))) %>% 
  mutate(Age_limit = factor(Age_limit, 
                            levels = as.character(c("0", "16", "17", "18", "20", "21", "25", "99")))) %>% 
  rename("drinker_rate" = drinker_percentage,
         "heavy_rate" = heavy_drinker_percentage)
```

Column {data-width=650}
---------------------------


### table


```{r}
limits_tidy %>% 
  ungroup() %>%
  summarise(mean_drinker_rate = mean(drinker_rate),
            mean_heavy_rate = mean(heavy_rate)) %>% 
  kable(caption = "Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```



### map

```{r}
world_map <- map_data("world") %>%
  right_join(limits_tidy, 
            by = c("region" = "country")) %>%
  select(-subregion)
worldMaps <- function(data_type){
if(data_type == "drinker_rate") 
  {
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = drinker_rate), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  
  
}
  else if(data_type == "heavy_rate") {
    
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = heavy_rate), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  
  
  }
  else if(data_type == "BAC_limits") {
    
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = BAC_limits), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  
  }
  else {
    
  p <- world_map %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group,
             text = region)) +
  geom_polygon(aes(fill = Age_limit), 
               colour = "gray50") +
  scale_x_continuous(breaks = seq(-180, 210, 45)) +
  scale_y_continuous(breaks = seq(-60, 100, 30)) +
  labs(x = "Longitude", 
       y = "Latitude") +
  theme_light()
  }
  return(p)
  #ggplotly(p)
}
```


```{r}
ui <- fluidPage(
    selectInput("variable", "Variable:",
                c("drinker_rate" = "drinker_rate", "heavy_rate" = "heavy_rate", "Age_limit" = "Age_limit", "BAC_limits" = "BAC_limits")),
    mainPanel(plotOutput(outputId = "plot_output"))
  )
server <- function(input,output,session) {
    output$plot_output <- renderPlot({
      worldMaps(input$variable)
    })
  }
shinyApp(ui=ui, server=server, options = list(height = 500), enableBookmarking = "server")
```





Column {data-width=350}
---------------------------


### Analysis
  
* Based on 15-19 years old adolescents  
* Youth drinker mean percentage across world: 31.2%  
* Youth heavy drinker mean percentage  
(Based on drinkers) across world: 48.5%  
* Roughly high rate  
  
    
    
* Low rate of drinkers:  
**The Middle East** & **North Africa**    
  
* High rate of drinkers:  
**USA** & **Argentina** & **Australia** & **European countries** 
  
* Possible reasons:  
  + Low rate   
    - Age restriction: "Total Ban"   
    - Religion: Islam (Alcohol Forbidden)  
  + High rate
    - Rich drinking culture
    - Rich in wine
      
* Low rate of heavy drinkers: 
**The Middle East** & **North Africa**     
    
* High rate of heavy drinkers:  
**Russia** & **West Africa**
   
* Possible reasons:    
  + Low rate 
    - Same as above   
  + High rate  
    - BAC restriction: more relaxed  
    - Economic depression  
    - Drinking culture  
    - National character  
    - Natural cold  




Youth Inebriation {.tabset}
======================

```{r}
at_least_once_a_week_tidy <- read_csv(here::here("clean_data/at_least_once_a_week_tidy.csv"))
first_drink_earlier_than_13_tidy <- read_csv(here::here("clean_data/first_drink_earlier_than_13_tidy.csv"))
any_alcohol_in_past_12_months_tidy <- read_csv(here::here("clean_data/any_alcohol_in_past_12_months_tidy.csv"))
any_alcohol_in_past_30_days_tidy <- read_csv(here::here("clean_data/any_alcohol_in_past_30_days_tidy.csv"))
```

```{r}
youth_drinking1 <- first_drink_earlier_than_13_tidy %>% 
  filter(!gender == "All") %>% 
  full_join(at_least_once_a_week_tidy, 
            by = c("country", "year", "gender")) %>% 
  rename("first_drink_earlier_than_13_percentage" = percentage.x,
         "at_least_once_a_week_percentage" = percentage.y) %>% 
  filter(!is.na(first_drink_earlier_than_13_percentage),
         !is.na(at_least_once_a_week_percentage)) %>% 
  group_by(country, gender) %>%
  summarise(first_drink_earlier_than_13_mean = mean(first_drink_earlier_than_13_percentage),
            at_least_once_a_week_mean = mean(at_least_once_a_week_percentage))

```


```{r}
youth_drinking2 <- any_alcohol_in_past_12_months_tidy %>% 
  filter(!str_detect(gender, "All"),
         !is.na(percentage)) %>% 
  group_by(country, gender) %>% 
  summarise(any_alcohol_in_past_12_months_mean = mean(percentage))

youth_drinking3 <- any_alcohol_in_past_30_days_tidy %>% 
  filter(!str_detect(gender, "All"),
         !is.na(percentage)) %>% 
  group_by(country, gender) %>% 
  summarise(any_alcohol_in_past_30_days_mean = mean(percentage))
```

```{r}
youth_drinking <- youth_drinking1 %>% 
  left_join(youth_drinking2) %>%
  left_join(youth_drinking3) %>% 
  filter(!is.na(any_alcohol_in_past_12_months_mean),
         !is.na(any_alcohol_in_past_30_days_mean)) %>% 
  select(-first_drink_earlier_than_13_mean) %>% 
  pivot_longer(cols = -c(country, gender),
               names_to = "frequency",
               values_to = "percentage") %>%
  mutate(country = ifelse(country == "United Kingdom of Great Britain and Northern Ireland", "UK", country),
         country = ifelse(country == "United States of America", "USA", country),
         country = ifelse(country == "Russian Federation", "Russia", country))

youth_drinking$frequency <- factor(youth_drinking$frequency, levels = c("at_least_once_a_week_mean", "any_alcohol_in_past_30_days_mean", "any_alcohol_in_past_12_months_mean"))
```

Column 
---------------------------

### Barplot

```{r, fig.height=6}
freq <- youth_drinking %>% 
  ggplot(aes(x = percentage,
             y = reorder(country, desc(percentage)),
             fill = gender,
             text = country)) +
  geom_col() +
  facet_grid(~frequency, scales = "free_x") +
  theme_bw() + 
  scale_fill_brewer(palette = "Paired")

ggplotly(freq)
```

  
 


### Analysis  
  
* Based on 15-year-old adolescents & mainly based in Europe  
* Low frequency:  
**Northern Europe**  
* High frequency:  
**Malta** & **Czech** & **Denmark** & **Austria** etc.    
* Possible reasons:  
  + Good taste   
  + Low price   
* Examples: (According to a European study *ESPAD*)       
  + Danish children: most enthusiastic drinkers  
  + Icelandic teenagers: not being attracted to addictive substances  



Limitations {.tabset} 
======================

Column {.tabset}
---------------------------
### Popularity

### Cause of Mortality

### Policy Patterns

1. The values for each policy area have not been weighted by importance.
2. Data is not available for a large number of countries so the analysis has been performed on the limited data set given.
3. This analysis has only been limited between the years of 2010-2016.
4. There could be population/age bias as demographic data is unavailable.



### Age Restrictions

### Youth Inebriation

References {.tabset}
======================

GHO | global information system on alcohol and Health (gisah) | global information system on alcohol and health. (n.d.). Retrieved May 09, 2021, from https://apps.who.int/gho/data/node.gisah.GISAH?lang=en&amp;showonly=GISAH

Need to control alcohol consumption. (2017, January 24). Retrieved May 15, 2021, from https://kuenselonline.com/need-to-control-alcohol-consumption/